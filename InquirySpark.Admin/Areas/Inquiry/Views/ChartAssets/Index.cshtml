@model IEnumerable<InquirySpark.Repository.Services.Charting.ChartAssetDto>

@{
    ViewData["Title"] = "Chart Assets Library";
}

<div class="card border-0 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h2 class="mb-0">
            <i class="bi bi-images"></i> Chart Assets Library
        </h2>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="bi bi-funnel"></i> Filters
            </button>
            <a asp-area="Inquiry" asp-controller="ChartAssets" asp-action="Analytics" class="btn btn-outline-light btn-sm">
                <i class="bi bi-graph-up"></i> Analytics
            </a>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0 datatable-export">
                <thead class="table-light">
                    <tr>
                        <th class="no-sort" style="width: 40px;">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th><i class="bi bi-image"></i> Preview</th>
                        <th><i class="bi bi-file-text"></i> Name</th>
                        <th><i class="bi bi-tags"></i> Tags</th>
                        <th><i class="bi bi-check-circle"></i> Status</th>
                        <th><i class="bi bi-download"></i> Downloads</th>
                        <th><i class="bi bi-calendar"></i> Generated</th>
                        <th class="no-sort">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var asset in Model)
                    {
                        <tr data-asset-id="@asset.ChartAssetId">
                            <td>
                                <input type="checkbox" class="form-check-input asset-checkbox" value="@asset.ChartAssetId">
                            </td>
                            <td>
                                @if (asset.Files.Any(f => f.Format == "Thumbnail"))
                                {
                                    var thumbnail = asset.Files.First(f => f.Format == "Thumbnail");
                                    <img src="@thumbnail.BlobPath" alt="Preview" class="img-thumbnail" style="max-width: 80px; max-height: 60px;">
                                }
                                else
                                {
                                    <div class="bg-light border rounded d-flex align-items-center justify-content-center" style="width: 80px; height: 60px;">
                                        <i class="bi bi-image text-muted"></i>
                                    </div>
                                }
                            </td>
                            <td>
                                <strong>@asset.DisplayName</strong><br />
                                <small class="text-muted">@asset.ChartDefinitionName</small>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(asset.Tags))
                                {
                                    foreach (var tag in asset.Tags.Split(','))
                                    {
                                        <span class="badge bg-secondary me-1">@tag.Trim()</span>
                                    }
                                }
                            </td>
                            <td>
                                @if (asset.ApprovalStatus == "Approved")
                                {
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Approved</span>
                                }
                                else if (asset.ApprovalStatus == "Draft")
                                {
                                    <span class="badge bg-warning"><i class="bi bi-pencil"></i> Draft</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary"><i class="bi bi-archive"></i> Archived</span>
                                }
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info">@asset.UsageCount</span>
                            </td>
                            <td>
                                <small class="text-muted">@asset.GenerationDt.ToString("yyyy-MM-dd")</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a asp-action="Details" asp-route-id="@asset.ChartAssetId" 
                                       class="btn btn-outline-info" 
                                       title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    @if (asset.Files.Any(f => f.Format == "PNG"))
                                    {
                                        var pngFile = asset.Files.First(f => f.Format == "PNG");
                                        <a href="@pngFile.BlobPath" 
                                           class="btn btn-outline-primary download-btn" 
                                           data-asset-id="@asset.ChartAssetId"
                                           data-format="PNG"
                                           download
                                           title="Download PNG">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    }
                                    @if (User.IsInRole("Operator"))
                                    {
                                        <button type="button" 
                                                class="btn btn-outline-success approve-btn"
                                                data-asset-id="@asset.ChartAssetId"
                                                title="Approve"
                                                @(asset.ApprovalStatus == "Approved" ? "disabled" : "")>
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-muted d-flex justify-content-between align-items-center">
        <span>
            <i class="bi bi-info-circle"></i> Total: @Model.Count() assets
        </span>
        <div>
            @if (User.IsInRole("Operator"))
            {
                <button type="button" class="btn btn-sm btn-outline-success" id="batchApproveBtn" disabled>
                    <i class="bi bi-check-circle"></i> Approve Selected
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" id="batchArchiveBtn" disabled>
                    <i class="bi bi-archive"></i> Archive Selected
                </button>
            }
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">
                    <i class="bi bi-funnel"></i> Filter Chart Assets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Index" method="get">
                    <div class="mb-3">
                        <label for="searchText" class="form-label">Search Text</label>
                        <input type="text" class="form-control" id="searchText" name="searchText" 
                               value="@ViewBag.SearchText" placeholder="Search by name or description">
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="tags" name="tags" 
                               value="@ViewBag.Tags" placeholder="e.g., quarterly, benchmark">
                    </div>
                    <div class="mb-3">
                        <label for="approvalStatus" class="form-label">Approval Status</label>
                        <select class="form-select" id="approvalStatus" name="approvalStatus">
                            <option value="">All</option>
                            <option value="Draft" selected="@(ViewBag.ApprovalStatus == "Draft")">Draft</option>
                            <option value="Approved" selected="@(ViewBag.ApprovalStatus == "Approved")">Approved</option>
                            <option value="Archived" selected="@(ViewBag.ApprovalStatus == "Archived")">Archived</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Apply Filters
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize DataTables with export buttons (handled by site.js)
        
        // Select all checkbox handler
        document.getElementById('selectAll')?.addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.asset-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateBatchButtons();
        });

        // Individual checkbox handler
        document.querySelectorAll('.asset-checkbox').forEach(cb => {
            cb.addEventListener('change', updateBatchButtons);
        });

        function updateBatchButtons() {
            const selected = document.querySelectorAll('.asset-checkbox:checked').length;
            document.getElementById('batchApproveBtn')?.toggleAttribute('disabled', selected === 0);
            document.getElementById('batchArchiveBtn')?.toggleAttribute('disabled', selected === 0);
        }

        // Download tracking
        document.querySelectorAll('.download-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const assetId = this.dataset.assetId;
                const format = this.dataset.format;
                
                fetch(`/Inquiry/ChartAssets/TrackDownload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assetId, format })
                });
            });
        });

        // Batch approve
        document.getElementById('batchApproveBtn')?.addEventListener('click', async function() {
            const selected = Array.from(document.querySelectorAll('.asset-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selected.length === 0) return;
            
            if (!confirm(`Approve ${selected.length} asset(s)?`)) return;
            
            const response = await fetch('/Inquiry/ChartAssets/BatchApprove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(selected)
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Assets approved successfully');
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        });

        // Batch archive
        document.getElementById('batchArchiveBtn')?.addEventListener('click', async function() {
            const selected = Array.from(document.querySelectorAll('.asset-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selected.length === 0) return;
            
            if (!confirm(`Archive ${selected.length} asset(s)?`)) return;
            
            const response = await fetch('/Inquiry/ChartAssets/BatchArchive', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(selected)
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Assets archived successfully');
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        });
    </script>
}
