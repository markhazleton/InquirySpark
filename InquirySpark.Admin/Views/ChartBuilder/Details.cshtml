@model InquirySpark.Repository.Models.Charting.ChartDefinitionDto
@{
    ViewData["Title"] = "Chart Definition Details";
}

<div class="card border-0 shadow-sm mb-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h2 class="mb-0"><i class="bi bi-bar-chart-fill"></i> @Model.Name</h2>
        <div class="btn-group btn-group-sm">
            <a asp-action="Edit" asp-route-id="@Model.ChartDefinitionId" class="btn btn-light">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a asp-action="History" asp-route-id="@Model.ChartDefinitionId" class="btn btn-light">
                <i class="bi bi-clock-history"></i> History
            </a>
            <a asp-action="Delete" asp-route-id="@Model.ChartDefinitionId" class="btn btn-light text-danger">
                <i class="bi bi-trash"></i> Delete
            </a>
        </div>
    </div>
    <div class="card-body">
        <dl class="row">
            <dt class="col-sm-3"><i class="bi bi-hash"></i> Chart ID</dt>
            <dd class="col-sm-9">@Model.ChartDefinitionId</dd>

            <dt class="col-sm-3"><i class="bi bi-database"></i> Dataset ID</dt>
            <dd class="col-sm-9">@Model.DatasetId</dd>

            <dt class="col-sm-3"><i class="bi bi-file-text"></i> Name</dt>
            <dd class="col-sm-9"><strong>@Model.Name</strong></dd>

            <dt class="col-sm-3"><i class="bi bi-text-paragraph"></i> Description</dt>
            <dd class="col-sm-9">@(Model.Description ?? "No description provided")</dd>

            <dt class="col-sm-3"><i class="bi bi-tags"></i> Tags</dt>
            <dd class="col-sm-9">
                @if (!string.IsNullOrEmpty(Model.Tags))
                {
                    foreach (var tag in Model.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                    {
                        <span class="badge bg-secondary me-1">@tag.Trim()</span>
                    }
                }
                else
                {
                    <span class="text-muted">No tags</span>
                }
            </dd>

            <dt class="col-sm-3"><i class="bi bi-arrow-repeat"></i> Version</dt>
            <dd class="col-sm-9"><span class="badge bg-info">v@Model.VersionNumber</span></dd>

            <dt class="col-sm-3"><i class="bi bi-check-circle"></i> Status</dt>
            <dd class="col-sm-9">
                @if (Model.AutoApprovedFl)
                {
                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Approved</span>
                }
                else
                {
                    <span class="badge bg-warning"><i class="bi bi-clock"></i> Draft</span>
                }
            </dd>

            <dt class="col-sm-3"><i class="bi bi-calendar-plus"></i> Created</dt>
            <dd class="col-sm-9">@Model.CreatedDt.ToString("yyyy-MM-dd HH:mm:ss") (User ID: @Model.CreatedById)</dd>

            <dt class="col-sm-3"><i class="bi bi-calendar-check"></i> Last Modified</dt>
            <dd class="col-sm-9">@Model.ModifiedDt.ToString("yyyy-MM-dd HH:mm:ss") (User ID: @Model.ModifiedById)</dd>
        </dl>
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Configuration</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.FilterPayload))
                {
                    <pre class="bg-light p-3 rounded"><code>@Model.FilterPayload</code></pre>
                }
                else
                {
                    <p class="text-muted">No filter configuration defined</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-12 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-palette"></i> Visual Configuration (Chart.js)</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.VisualPayload))
                {
                    <pre class="bg-light p-3 rounded"><code>@Model.VisualPayload</code></pre>
                    <div id="chartPreview" style="max-width: 800px; margin: 20px auto;">
                        <canvas id="previewCanvas"></canvas>
                    </div>
                }
                else
                {
                    <p class="text-muted">No visual configuration defined</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-12 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-calculator"></i> Calculation Logic</h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.CalculationPayload))
                {
                    <pre class="bg-light p-3 rounded"><code>@Model.CalculationPayload</code></pre>
                }
                else
                {
                    <p class="text-muted">No calculation logic defined</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between mt-3">
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Library
    </a>
    <a asp-action="Edit" asp-route-id="@Model.ChartDefinitionId" class="btn btn-primary">
        <i class="bi bi-pencil"></i> Edit Chart
    </a>
</div>

@section Scripts {
    <script src="~/lib/chart.js/dist/chart.umd.js"></script>
    <script>
        // Chart.js preview rendering (if visual payload exists)
        @if (!string.IsNullOrEmpty(Model.VisualPayload))
        {
            <text>
            try {
                const config = @Html.Raw(Model.VisualPayload);
                const ctx = document.getElementById('previewCanvas').getContext('2d');
                new Chart(ctx, config);
            } catch (e) {
                console.error('Failed to render chart preview:', e);
                document.getElementById('chartPreview').innerHTML = 
                    '<div class="alert alert-warning">Unable to render chart preview. Check visual configuration syntax.</div>';
            }
            </text>
        }
    </script>
}
