@model IEnumerable<InquirySpark.Repository.Services.Charting.ChartVersionDto>
@{
    ViewData["Title"] = "Version History";
    var chartDefinition = ViewBag.ChartDefinition as InquirySpark.Repository.Models.Charting.ChartDefinitionDto;
}

<div class="card border-0 shadow-sm mb-3">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0">
            <i class="bi bi-clock-history"></i> Version History: @chartDefinition?.Name
        </h2>
    </div>
    <div class="card-body">
        <p class="text-muted">
            <i class="bi bi-info-circle"></i> View all versions of this chart definition. 
            You can rollback to any previous version if needed.
        </p>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th><i class="bi bi-arrow-repeat"></i> Version</th>
                        <th><i class="bi bi-check-circle"></i> Status</th>
                        <th><i class="bi bi-text-left"></i> Summary</th>
                        <th><i class="bi bi-calendar"></i> Approved Date</th>
                        <th><i class="bi bi-person"></i> Approved By</th>
                        <th><i class="bi bi-arrow-clockwise"></i> Rollback Source</th>
                        <th class="no-sort">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var version in Model)
                    {
                        var isCurrent = version.VersionNumber == chartDefinition?.VersionNumber;
                        <tr class="@(isCurrent ? "table-primary" : "")">
                            <td>
                                <strong>v@version.VersionNumber</strong>
                                @if (isCurrent)
                                {
                                    <span class="badge bg-success ms-2">Current</span>
                                }
                            </td>
                            <td>
                                @if (version.ApprovedFl)
                                {
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Approved</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning"><i class="bi bi-clock"></i> Draft</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(version.DiffSummary))
                                {
                                    <small>@version.DiffSummary</small>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (version.ApprovedDt.HasValue)
                                {
                                    @version.ApprovedDt.Value.ToString("yyyy-MM-dd HH:mm")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (version.ApprovedById.HasValue)
                                {
                                    <span>User @version.ApprovedById</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (version.RollbackSourceVersionNumber.HasValue)
                                {
                                    <span class="badge bg-info">From v@version.RollbackSourceVersionNumber</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    @if (!isCurrent)
                                    {
                                        <form asp-action="Rollback" method="post" class="d-inline" 
                                              onsubmit="return confirm('Are you sure you want to rollback to version @version.VersionNumber?');">
                                            <input type="hidden" name="id" value="@chartDefinition?.ChartDefinitionId" />
                                            <input type="hidden" name="versionNumber" value="@version.VersionNumber" />
                                            <button type="submit" class="btn btn-outline-warning" title="Rollback to this version">
                                                <i class="bi bi-arrow-counterclockwise"></i> Rollback
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-outline-secondary" disabled>
                                            <i class="bi bi-check"></i> Current
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-muted d-flex justify-content-between align-items-center">
        <span><i class="bi bi-info-circle"></i> Total: @Model.Count() versions</span>
        <span><i class="bi bi-shield-check"></i> Current version: v@chartDefinition?.VersionNumber</span>
    </div>
</div>

<div class="mt-3">
    <a asp-action="Details" asp-route-id="@chartDefinition?.ChartDefinitionId" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Details
    </a>
</div>
